# Arthas `http-trace` 命令: 需求文档 (V3.1)

## 1. 命令名称

**`http-trace`** (别名: **`ht`**)

## 2. 需求概述

在 Arthas 中新增一个命令 `http-trace` (及其别名 `ht`)。该命令旨在跟踪进入一个基于 Tomcat (或类似 Servlet 容器) 的应用的单次 HTTP 请求。它会记录请求处理生命周期中的关键步骤、耗时和详细信息。这为用户提供了一个在生产环境中进行按需性能诊断和逻辑跟踪的非侵入式工具。

## 3. 功能性需求: `http-trace` 命令

- **FR-0**: `http-trace` 命令必须提供一个简短的别名 `ht`，两者功能完全等价。

### 3.1. 请求匹配

- **FR-1**: 命令必须能够基于 URL 模式 (例如，Ant 风格的 `/api/**` 或正则表达式) 来匹配特定的 HTTP 请求。
- **FR-2**: 命令必须能够按 HTTP 方法 (例如 `GET`, `POST`) 匹配请求。
- **FR-3**: 如果未提供匹配条件，命令必须跟踪进入系统的下一个 HTTP 请求。
- **FR-4**: 命令必须支持一个计数参数，以连续跟踪 N 个满足条件的请求。

### 3.2. 探针 (Probe)

- **FR-5**: 命令必须能够通过启用不同的 **探针 (Probe)** 来捕获特定组件的调用。内置的探针必须包括：
    - **`jdbc`**: 捕获 `java.sql.Statement` 和 `java.sql.PreparedStatement` 的执行，记录 SQL 语句和执行耗时。
    - **`redis`**: 捕获主流 Redis 客户端 (如 Jedis, Lettuce) 的命令执行，记录 Redis 命令、键和执行耗时。
    - **`kafka`**: 捕获 Kafka Producer 的 `send` 操作，记录 Topic、消息 Key 和执行耗时。
    - **`http`**: 捕获主流 HTTP 客户端 (如 Apache HttpClient, OkHttp) 的出站调用，记录请求 URL、方法和执行耗时。
- **FR-6**: 用户必须能通过参数 (例如 `--probes jdbc,redis`) 来选择和组合探针。默认情况下，应启用 `jdbc`、`redis` 和 `kafka` 探针。
- **FR-7**: 系统必须是可扩展的，以便将来可以方便地添加新的探针 (例如 `dubbo`, `mongodb`)。

### 3.3. Trace ID 关联

- **FR-8**: 命令必须为每次独立的请求跟踪生成一个全局唯一的 **Arthas Trace ID** (例如，使用 UUID)。此 ID 由 Arthas 生成，并且必须存在于每个跟踪结果中。
- **FR-9**: 命令必须支持用户提供一个表达式 (例如 OGNL)，以从当前 HTTP 请求 (`HttpServletRequest` 对象) 的任何部分 (如请求头、参数或 Cookie) 提取 **业务 Trace ID**。
- **FR-10**: **Arthas Trace ID** 和任何成功提取的 **业务 Trace ID** 都必须在最终输出中清晰地显示。

### 3.4. 输出与格式

- **FR-11**: 执行后，命令必须在控制台中以清晰的树状结构显示跟踪结果。输出的头部应包含 **Arthas Trace ID**。
- **FR-12**: 树状结构中的节点必须严格按照它们的实际执行顺序列出。子节点代表嵌套调用。
- **FR-13**: 每个节点必须清晰地显示其来源探针类型 (如 JDBC, Redis)、持续时间以及关键信息 (如 SQL 语句, Redis 命令)。
- **FR-14**: 必须提供一个参数 (例如 `--stack-trace-threshold <ms>`) 来捕获线程的调用堆栈。
    - **机制**: 只有当探针 (如 JDBC) 记录的事件的执行耗时超过指定的毫秒阈值时，才会捕获其堆栈跟踪。
    - **特殊值**: 如果阈值设置为 `0`，将为所有被探测到的事件捕获堆栈跟踪。
- **FR-15**: 捕获的堆栈跟踪必须在输出中显示。
    - **控制台**: 堆栈跟踪应格式化并显示在其对应节点的下方。默认情况下可能会被截断，在 `--verbose` 模式下会完整显示。
    - **JSON 文件**: `traceTree` 节点对象必须包含一个可选的 `stackTrace` 字段，其中包含一个由字符串组成的数组形式的堆栈跟踪。
- **FR-16**: 用户必须可以选择将跟踪输出定向到指定的文件。
- **FR-17**: **默认文件格式**: 当未指定自定义格式时，写入文件的输出必须是包含所有跟踪信息的单行、完整的 JSON 对象。
- **FR-18**: **自定义文件格式**: 用户必须能够通过一个参数 (例如 `--output-format <template>`) 提供一个模板字符串，来为文件输出定义自定义格式。
    - 可用的占位符必须至少包括：`${arthasTraceId}`, `${businessTraceId}`, `${totalTimeMs}`, `${request.url}`, `${request.method}`, `${timestamp}` 和 `${traceSummary}` (一个紧凑的、单行的调用链摘要)。
- **FR-19**: 数据必须以追加模式写入输出文件，以防止覆盖以前的记录。
- **FR-20**: 必须提供一个 `--verbose` 开关来控制输出的详细程度。

## 4. 核心功能: 全局配置系统

### 4.1. 概述

- **FR-21**: 必须引入一个新的、通用的顶层命令 `config`，用于管理所有 Arthas 命令的默认参数值。
- **FR-22**: 所有现有和未来的 Arthas 命令都必须能够从这个新的配置系统中读取它们的默认参数值。

### 4.2. 配置键命名空间

- **FR-23**: 为防止命令之间的参数名冲突，所有配置键都必须使用命名空间格式：`<command_name>.<parameter_name>`。
    - **示例**:
        - `http-trace.url-pattern`
        - `watch.express`
        - `options.unsafe`

### 4.3. 配置加载优先级

- **FR-24**: 参数值必须按照以下降序优先级解析：
    1.  **命令行参数**: 最高优先级。
    2.  **项目级配置**: 应用工作目录中的 `arthas.properties` 文件。
    3.  **用户级配置**: 用户主目录 (`~/.arthas/`) 中的 `arthas.properties` 文件。
    4.  **命令内置默认值**: 最低优先级。

### 4.4. `config` 命令功能

- **FR-25**: `config` 命令必须支持以下操作：
    - **查看**:
        - `config --list`: 显示所有当前生效的配置键及其最终值。
        - `config <key>`: 显示特定键的最终值。
    - **设置/更新**:
        - `config <key> <value>`: 在项目级配置文件中设置一个键值对。
        - `config --global <key> <value>`: 在用户级配置文件中设置一个键值对。
    - **取消设置**:
        - `config --unset <key>`: 从项目级配置文件中移除一个键。
        - `config --global --unset <key>`: 从用户级配置文件中移除一个键。

### 4.5. 配置文件格式

- **FR-26**: 配置文件必须使用标准的 Java `.properties` 键值对格式。

## 5. 非功能性需求

- **NFR-1 (性能)**: 命令对目标应用的影响应最小化。具有较高开销的功能 (如堆栈跟踪捕获) 必须默认禁用。
- **NFR-2 (易用性)**: 命令和参数名应直观。配置系统应简化重复的命令使用。
- **NFR-3 (可靠性)**: 命令必须是健壮的，不应导致目标应用崩溃或出现意外行为。
- **NFR-4 (可发现性)**: 用户应能通过 `config --list` 轻松发现所有可配置的选项及其当前值。
