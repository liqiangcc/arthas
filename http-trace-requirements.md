# Arthas `http-trace` Command: Requirements Document (V3.1)

## 1. Command Name

**`http-trace`** (Alias: **`ht`**)

## 2. Overview

A new command, `http-trace` (and its alias `ht`), will be added to Arthas. This command is designed to trace a single HTTP request entering a Tomcat (or similar Servlet container) based application. It records key steps, timings, and detailed information during the request's processing lifecycle. This provides users with a non-intrusive tool for on-demand performance diagnostics and logic tracing in a live environment.

## 3. Functional Requirements: `http-trace` Command

- **FR-0**: The `http-trace` command must have a short alias, `ht`. Both are functionally identical.

### 3.1. Request Matching

- **FR-1**: The command must be able to match specific HTTP requests based on a URL pattern (e.g., Ant-style `/api/**` or a regular expression).
- **FR-2**: The command must be able to match requests by their HTTP method (e.g., `GET`, `POST`).
- **FR-3**: If no matching conditions are provided, the command must trace the next single HTTP request that enters the system.
- **FR-4**: The command must support a count parameter to trace N consecutive requests that meet the specified criteria.

### 3.2. Probes

- **FR-5**: The command must be able to enable different **Probes** to capture calls from specific components. Built-in probes must include:
    - **`jdbc`**: Captures executions from `java.sql.Statement` and `java.sql.PreparedStatement`, recording the SQL statement and execution time.
    - **`redis`**: Captures command executions from mainstream Redis clients (e.g., Jedis, Lettuce), recording the Redis command, key, and execution time.
    - **`kafka`**: Captures `send` operations from the Kafka Producer, recording the topic, message key, and execution time.
    - **`http`**: Captures outbound calls from mainstream HTTP clients (e.g., Apache HttpClient, OkHttp), recording the request URL, method, and execution time.
- **FR-6**: Users must be able to select and combine probes via a parameter (e.g., `--probes jdbc,redis`). By default, the `jdbc`, `redis`, and `kafka` probes should be enabled.
- **FR-7**: The system must be extensible to allow for the future addition of new probes (e.g., `dubbo`, `mongodb`).

### 3.3. Trace ID Correlation

- **FR-8**: The command must generate a globally unique **Arthas Trace ID** (e.g., using UUID) for each independent request trace. This ID is generated by Arthas and must be present in every trace result.
- **FR-9**: The command must support a user-provided expression (e.g., OGNL) to extract a **Business Trace ID** from any part of the current HTTP request (`HttpServletRequest` object), such as headers, parameters, or cookies.
- **FR-10**: Both the **Arthas Trace ID** and any successfully extracted **Business Trace ID** must be clearly displayed in the final output.

### 3.4. Output and Formatting

- **FR-11**: After execution, the command must display the trace result in a clear, tree-like structure in the console. The header of the output should include the **Arthas Trace ID**.
- **FR-12**: The nodes within the tree structure must be strictly ordered according to their actual execution sequence. Child nodes represent nested calls.
- **FR-13**: Each node must clearly display its source probe type (e.g., JDBC, Redis), its duration, and key information (e.g., SQL statement, Redis command).
- **FR-14**: A parameter (e.g., `--stack-trace-threshold <ms>`) must be available to capture the thread's call stack.
    - **Mechanism**: The stack trace is captured only when an event recorded by a probe (e.g., JDBC) exceeds the specified time threshold in milliseconds.
    - **Special Value**: If the threshold is set to `0`, the stack trace will be captured for all probed events.
- **FR-15**: The captured stack trace must be displayed in the output.
    - **Console**: The stack trace should be formatted and displayed below its corresponding node in the tree. It may be truncated by default and fully displayed in `--verbose` mode.
    - **JSON File**: The `traceTree` node object must include an optional `stackTrace` field, containing the stack trace as an array of strings.
- **FR-16**: Users must have the option to direct the trace output to a specified file.
- **FR-17**: **Default File Format**: When no custom format is specified, the output written to the file must be a single-line, complete JSON object containing all trace information.
- **FR-18**: **Custom File Format**: Users must be able to provide a template string via a parameter (e.g., `--output-format <template>`) to define a custom format for the file output.
    - Available placeholders must include at least: `${arthasTraceId}`, `${businessTraceId}`, `${totalTimeMs}`, `${request.url}`, `${request.method}`, `${timestamp}`, and `${traceSummary}` (a compact, single-line summary of the call chain).
- **FR-19**: Data must be appended to the output file to prevent overwriting previous records.
- **FR-20**: A `--verbose` switch must be available to control the level of detail in the output.

## 4. Core Feature: Global Configuration System

### 4.1. Overview

- **FR-21**: A new, generic, top-level command, `config`, must be introduced to manage default parameter values for all Arthas commands.
- **FR-22**: All existing and future Arthas commands must be able to read their default parameter values from this new configuration system.

### 4.2. Configuration Key Namespace

- **FR-23**: To prevent parameter name collisions between commands, all configuration keys must use a namespace format: `<command_name>.<parameter_name>`.
    - **Examples**:
        - `http-trace.url-pattern`
        - `watch.express`
        - `options.unsafe`

### 4.3. Configuration Loading Priority

- **FR-24**: Parameter values must be resolved in the following descending order of priority:
    1.  **Command-line Arguments**: Highest priority.
    2.  **Project-level Configuration**: An `arthas.properties` file in the application's working directory.
    3.  **User-level Configuration**: An `arthas.properties` file in the user's home directory (`~/.arthas/`).
    4.  **Command-internal Defaults**: Lowest priority.

### 4.4. `config` Command Functionality

- **FR-25**: The `config` command must support the following operations:
    - **View**:
        - `config --list`: Display all currently effective configuration keys and their final values.
        - `config <key>`: Display the final value of a specific key.
    - **Set/Update**:
        - `config <key> <value>`: Set a key-value pair in the project-level configuration file.
        - `config --global <key> <value>`: Set a key-value pair in the user-level configuration file.
    - **Unset**:
        - `config --unset <key>`: Remove a key from the project-level configuration file.
        - `config --global --unset <key>`: Remove a key from the user-level configuration file.

### 4.5. Configuration File Format

- **FR-26**: Configuration files must use the standard Java `.properties` key-value format.

## 5. Non-Functional Requirements

- **NFR-1 (Performance)**: The command's impact on the target application should be minimal. Features with higher overhead (like stack trace capturing) must be disabled by default.
- **NFR-2 (Usability)**: Command and parameter names should be intuitive. The configuration system should simplify repeated command usage.
- **NFR-3 (Reliability)**: The command must be robust and not cause the target application to crash or behave unexpectedly.
- **NFR-4 (Discoverability)**: Users should be able to easily discover all configurable options and their current values using `config --list`.
